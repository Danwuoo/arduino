# 1. 架構概觀

**分層**：S0 電源保護 → S1 感測 → S2 執行 → S3 決策狀態機 → S4 系統服務 → S5 人機/通訊。

**資料流**：感測快照（雙緩衝）→ FSM 決策 → 馬達命令 → 事件/日誌（環形）。

**硬體方塊**：太陽能與鋰電 → BMS/升降壓 → 馬達驅動×2、限位×4、E‑Stop、雨量、BH1750、DHT22、（可選）風速、電流感測、LCD（I²C）。

---

# 2. 具體硬體規劃（建議值）

## 2.1 電源與保護（S0）

*   鋰電：1S 18650/21700，BMS 10–15A（帶短路與過流）。
*   升壓：到 12V（依馬達定格），效率>90%，含軟啟動。
*   5V/3V3：Buck 到 5V（LCD/感測），再 LDO 到 3V3（ESP32）。
*   斷路與防反：主保險絲 10–15A，TVS（SMBJ58A 依馬達線路），肖特基 OR’ing（若雙源）。
*   馬達端：TVS + 100nF 並聯，驅動板近端電解 470–1000µF。
*   接地：功率與邏輯星形匯流，單點接地；感測回路分區。

## 2.2 馬達與驅動（S2）

*   A：捲線升降，12V DC 齒輪箱，額定 3–5A。
*   B：螺桿伸縮，12V DC 齒輪箱，額定 3–5A。
*   驅動選項：
    *   高側橋：BTS7960（43A 峰值）或 VNH2SP30 等 H-Bridge，支援 PWM。
    *   具電流回報者更佳（INA219/ACS712 做外掛亦可）。
*   線束：JST-VH/汽車級連接器；限位開關用 NC，屏蔽線對地於單端。

## 2.3 感測（S1）

*   光：BH1750（I²C，0x23/0x5C），1–120k lx。
*   溫濕：DHT22（1-Wire），取樣≥2 s。
*   雨量：數位輸出「濕=1」，板上可調比較器；輸出加 RC 1–2 s。
*   風速（選配）：霍爾或干簧脈衝式，K=脈衝/轉速→m/s。
*   電壓：分壓到 ADC1（建議 ≤1.8V full-scale，含 RC 1k/100nF）。
*   電流（選配）：ACS712/INA219；過流也可由驅動板 Fault pin。

---

# 3. I/O 腳位（ESP32 建議配置）

> 避開啟動綁定腳與 ADC2；限位/雨量用內建上拉，NC 常閉邏輯：開路=觸發。

| 功能 | 訊號 | GPIO | 方向 | 備註 |
| --- | --- | ---: | :-: | --- |
| I²C SDA | SDA | 21 | I/O | BH1750、LCD |
| I²C SCL | SCL | 22 | O | 4.7–10kΩ 拉阻 |
| 馬達A PWM | A\_PWM | 25 | O | 1–10 kHz |
| 馬達A 方向 | A\_DIR | 18 | O | |
| 馬達B PWM | B\_PWM | 26 | O | 1–10 kHz |
| 馬達B 方向 | B\_DIR | 19 | O | |
| 雨量輸入 | RAIN\_IN | 4 | I | RC 去抖 1–2 s |
| 限位 A 上 | LIM\_A\_UP | 34 | I | 入-only，內拉，上緣有效 |
| 限位 A 下 | LIM\_A\_DN | 35 | I | 入-only |
| 限位 B 伸 | LIM\_B\_EXT | 32 | I | |
| 限位 B 縮 | LIM\_B\_RET | 33 | I | |
| E‑Stop 讀取 | ESTOP\_IN | 27 | I | 硬切電路外加；此腳僅做狀態監測 |
| 風速脈衝 | WIND\_P | 14 | I | 上升沿中斷 |
| LCD 背光/蜂鳴 | UI\_IO | 23 | O | PWM 或數位 |
| 電池電壓 | VBAT\_ADC | 36(SVP) | I | ADC1，分壓到≤1.8V |
| 電流感測A | IA\_ADC | 39(SVN) | I | 選配 |
| 電流感測B | IB\_ADC | 32/33 可替 | I | 選配（與限位互斥時調整） |

---

# 4. 介面契約與資料模型（語義）

*   感測快照 `SensorSnap`：{ lux, rh, temp, rain, vbat, wind, iA, iB, ts }
*   安全快照 `SafetySnap`：{ limitAup, limitAdn, limitBext, limitBret, estop, ovrcurr, uvlo }
*   執行命令 `ActCmd`：A{ mode, dir, duty }, B{ ... }
*   事件 `Event`：{ code, ts, payload }
*   FSM：`tick(inputs) -> {state, cmd, events}`；單一事實來源。

**事件碼（摘要）**：

*   100x 狀態轉移；200x 故障（過流、感測失敗、雙限位衝突、欠壓鎖定）；300x 人機（按鍵、維修）；400x 校正/參數變更；500x 電源（喚醒、深睡）。

---

# 5. 狀態機詳細轉移表

**狀態**：IDLE, EXTENDING, RETRACTING, HOLD, DRY\_DONE, FAULT

| 來源 | 觸發條件 | 優先 | 目標 | 動作 | 備註 |
| --- | --- | -: | --- | --- | --- |
| 任意 | 過流>200ms 或雙限位同時真、感測失效>60s | 高 | FAULT | 停 A/B、鎖展開 | EVT=200x |
| 任意 | 雨=濕 或 lux<2k 或 vbat<3.6 或風>門檻 | 中 | RETRACTING | A下、B收 | 先降 duty 再動 |
| IDLE/HOLD | 無雨 且 lux>15k 且 vbat≥3.7 且無故障 | 中 | EXTENDING | A上、B伸 | 滯迴保持 |
| EXTENDING | 個別達極限 | 低 | EXTENDING/HOLD | 停該軸；兩軸皆到→HOLD | |
| RETRACTING | 個別達極限 | 低 | RETRACTING/HOLD | 停該軸；兩軸皆到→HOLD | |
| 任意 | 濕度<60% 連續≥15min | 低 | DRY\_DONE | 停止動作 | 仍受收回條件打斷 |
| FAULT | 維修解除 或 電壓恢復且自檢通過 | 中 | HOLD | 清故障旗標 | |

**動作限制**：硬體限向永不越界；A、B 並行，電壓下陷時優先保 A，B 降 duty。

---

# 6. 時序與斜率

*   PWM 頻率：3–5 kHz；啟動 50 ms 免責窗，之後進入過流積分判斷 200 ms。
*   Duty 斜率限制：每 10 ms 最大變化 5–10%（避免壓降）。
*   雨量去抖：1–2 s；光照移動平均：10 點（100–500 ms 取樣）。
*   欠壓延遲：偵測到 <3.6V 後 2 s，先降 duty 20%，再進 RETRACTING。

---

# 7. 任務/中斷/佇列設計（FreeRTOS）

| 任務 | 週期 | 優先 | 堆疊 | 職責 | IPC |
| --- | ---: | -: | ---: | --- | --- |
| T\_Safety | 10 ms | 4 | 2 KB | 讀限位/E‑Stop/過流；立即停 | Queue\:EvtSafety→FSM |
| T\_Actuator | 10 ms | 4 | 2 KB | 寫 PWM/方向；限向保護 | CmdQueue←FSM |
| T\_FSM | 100 ms | 3 | 4 KB | 決策與產生命令 | SnapQueue, SafetyQueue |
| T\_Sensors | 50–200 ms | 2 | 4 KB | I²C/ADC 並濾波；更新雙緩衝 | SnapDoubleBuf |
| T\_Power | 1 s | 2 | 2 KB | 低功耗策略、UVLO | |
| T\_UI | 200 ms | 1 | 3 KB | LCD/蜂鳴/按鍵 | |
| T\_Log | 1–5 s | 1 | 3 KB | 事件落盤/輸出 | RingBuffer 512 項 |

中斷：風速脈衝上升沿計數；限位/E‑Stop 以任務輪詢搭配硬切。

---

# 8. 門檻與濾波數值表（初始值）

| 參數 | 值 | 滯迴/窗 | 說明 |
| --- | ---: | --- | --- |
| 展開光照 | >15k lx | 2k/15k 帶 | 中間帶保持 |
| 收回光照 | <2k lx | 同上 | |
| 濕度完成 | <60%RH | 15 分窗 95% | |
| 風速收回 | >8–10 m/s | 展開解鎖 <5 m/s | 選配 |
| 欠壓鎖展 | <3.6 V | 解鎖 ≥3.7 V | 100 ms ×10 平均 |
| 過流軟停 | >1.8×Inom 200 ms | 啟動豁免 50 ms | |
| 過流硬停 | >3×Inom 即停 | – | |

---

# 9. 安全層級與互鎖

*   **硬體第一**：E‑Stop 直接切斷驅動供電或方向；限位為 NC 失效安全。
*   **軟體第二**：軟限位、過流積分、UVLO；任何安全事件中止 PWM。
*   **維修模式**：點動受限位保護；故障可清除；2 分鐘超時退出。

---

# 10. 低功耗與喚醒

*   深睡條件：IDLE/HOLD/DRY\_DONE 且 30 s 無事件。
*   喚醒源：定時 30 s、雨量腳 EXT1、按鍵。
*   喚醒流程：先兩輪感測 → 進 FSM，避免冷啟誤判。

---

# 11. 參數與 NVS Schema（鍵名範例）

| Key | 型別 | 預設 | 範圍 | 單位 | 說明 |
| --- | --- | --- | --- | --- | --- |
| config\_version | u8 | 1 | – | – | Schema 版本 |
| calib\_v\_slope | f32 | 1.00 | 0.8–1.2 | – | 電壓斜率 |
| calib\_v\_offset | f32 | 0.00 | -0.2–0.2 | V | 電壓位移 |
| lux\_open | u16 | 15000 | 2000–50000 | lx | 展開門檻 |
| lux\_close | u16 | 2000 | 0–10000 | lx | 收回門檻 |
| rh\_done | u8 | 60 | 40–80 | % | 完成 RH% |
| rh\_win\_min | u8 | 95 | 80–100 | % | 視窗內有效率 |
| wind\_close | f32 | 9.0 | 5–15 | m/s | 收回風速 |
| wind\_open | f32 | 5.0 | 2–10 | m/s | 允許展開風速 |
| vbat\_lock | f32 | 3.6 | 3.3–3.9 | V | 欠壓鎖展 |
| vbat\_unlock | f32 | 3.7 | 3.5–4.2 | V | 解鎖 |
| i\_soft | f32 | 1.8 | 1.2–2.5 | ×Inom | 過流軟停倍率 |
| i\_hard | f32 | 3.0 | 2.0–4.0 | ×Inom | 過流硬停倍率 |
| duty\_a\_max | u8 | 85 | 50–100 | % | A 最大 duty |
| duty\_b\_max | u8 | 85 | 50–100 | % | B 最大 duty |
| accel\_slope | u8 | 8 | 1–20 | %/10ms | 斜率限制 |
| sleep\_delay\_s | u16 | 30 | 5–600 | s | 深睡延遲 |
| log\_level | u8 | 2 | 0–3 | – | 0=關,1=錯,2=訊息,3=偵錯 |

---

# 12. 校正與自檢 SOP

1.  電池電壓：以 4.20V、3.70V 兩點量測記錄，計算 slope/offset 寫入。
2.  光照：日中與室內比對設定校正係數。
3.  過流：機構鎖死，記錄峰值，設定 1.8×、3× 措施。
4.  濕度窗：在 55–65%RH 場景 A/B 測試 3 次，驗證誤判 <1/週。
5.  自檢：限位斷線→應視為觸發；雨量常濕/常乾 5 分偵測出不一致→Fault。

---

# 13. 測試計畫

*   單元：感測器模擬掃描；極限開路/短路；馬達假負載；UVLO 行為。
*   整合劇本：
    *   晴天展開→午後陣雨→收回→雨停陰暗→保持收回。
    *   高濕烈日→展開→15 分達標→DRY\_DONE。
    *   低電壓→收回→充電回升→解鎖。
    *   E‑Stop 生效期間任何命令無效→復位後恢復。
*   長測：72 h 循環；觀察溫飽和、ADC 漂移、I²C 自復。
*   故障注入：拔 BH1750、雨量短路、限位線斷、加馬達脈衝干擾。
*   驗收指標：反應時間、誤判率、欠壓行為、待機與深睡電流、抗干擾。

---

# 實作快照（目前狀態）

- S1 感測：
  - BH1750 讀取＋10 點移動平均；雨量輸入 1.5s 去抖；電池電壓 ADC 讀值＋NVS 校正 `v_slope`/`v_offset`；風速脈衝 GPIO14 上升沿中斷，轉 PPS→m/s（係數 `WIND_PULSE_TO_MPS`）。
  - DHT22、電流感測留為 TODO（介面已預留）。
- S2 執行：
  - LEDC 5kHz PWM、方向腳；限位（NC）互鎖永不越界；E‑Stop 立即停。
  - Actuator 任務內建 Duty 斜率限制（每 10ms 最多 ±`DUTY_SLOPE_MAX_PER_10MS`）。
- S3 狀態機：
  - 中/高優先條件：雨/低光/UVLO 去抖 2s 收回；雙限位衝突 Fault；感測逾時>60s Fault。
  - 低優先條件：RH 低於門檻連續 15 分轉入 DRY_DONE。
  - Duty 上限由 NVS `duty_a_max`/`duty_b_max`（百分比）配置。
  - 事件：狀態轉移、UVLO on/off、Fault（雙限位/逾時/過流/E‑Stop）寫入 S4 環形緩衝。
- S4 系統服務：
  - NVS 初始化與參數讀寫；事件環形緩衝（512 項），`T_Log` 週期性輸出。
- 任務：
  - 已啟動 T_Safety、T_Actuator、T_Sensors、T_FSM、T_Power、T_Log；HMI（LCD/按鍵）待接。

## 使用與參數

- 校正：
  - 以兩點法量測 VBAT，寫入 `v_slope`、`v_offset`（NVS）。
  - `duty_a_max`/`duty_b_max`（%）、`lux_open`/`lux_close`、`vbat_lock`/`vbat_unlock` 可動態覆寫。
- 風速換算：
  - 依感測器規格調整 `WIND_PULSE_TO_MPS`（`main/project_config.h`）。

## TODO / 待辦

- DHT22 溫溼度驅動、風速係數校正；電流感測（ACS712/INA219）＋過流軟/硬停邏輯（200ms 積分/即停）。
- UVLO 下先降 Duty 20% 的預先動作目前由斜率限制近似，後續可加入明確階段。
- HMI：I²C LCD 顯示/按鍵輸入、維修模式與故障清除。
- 低功耗：深睡判斷與喚醒流程（EXT1/Timer）。

---

# 14. FMEA 摘要

| 功能 | 失效模式 | 影響 | 嚴重度S | 發生O | 探測D | RPN | 緩解 |
| --- | --- | --- | ---: | --: | --: | --: | --- |
| 雨量 | 常濕/常乾 | 誤動作 | 6 | 4 | 3 | 72 | 與光/風交叉檢；>5min 不一致→Fault |
| 光照 | 讀值掛起 | 誤判 | 5 | 3 | 4 | 60 | 超時降級；僅允許收回 |
| 限位 | 斷線 | 過行程 | 8 | 3 | 2 | 48 | NC 設計；軟體雙限位檢查 |
| 馬達 | 卡滯 | 過流 | 7 | 3 | 3 | 63 | 過流軟/硬停；人工復位 |
| 供電 | 欠壓抖動 | 循環重啟 | 6 | 3 | 4 | 72 | 延遲2s 降 duty 再收回 |

---

# 15. 製造/維修支援

*   量測點：VBAT、5V、3V3、A/B 相電流、限位回路測試點。
*   治具：限位觸發器、假負載阻尼器、雨量/風速模擬器。
*   清單：出廠檢查表、維修故障樹。
